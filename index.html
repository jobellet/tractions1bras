<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>Traction Ã  un bras â€“ 12 semaines (mobile)</title>
  <meta name="description" content="Programme 12 semaines optimisÃ© smartphone pour progresser vers la traction Ã  un bras. Timers intÃ©grÃ©s + export calendrier (.ics) pour alarmes qui sonnent Ã©cran Ã©teint." />
  <style>
    :root{
      --bg:#0b0d12; --panel:#121621; --panel-2:#1a2030; --text:#eef3fb; --muted:#9fb0c3;
      --accent:#58b7ff; --accent2:#00d18f; --warn:#ffd166; --danger:#ff6b6b; --ok:#7cf4b5;
      --border:rgba(255,255,255,.08); --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .light{ --bg:#f7f8fb; --panel:#ffffff; --panel-2:#f2f4f8; --text:#151a22; --muted:#4c5870; --accent:#0066ff; --accent2:#0cab6b; --border:rgba(0,0,0,.1); }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    .container{max-width:960px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,var(--bg),rgba(0,0,0,0));backdrop-filter:saturate(1.2) blur(6px)}
    .nav{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:color-mix(in srgb,var(--bg),transparent 30%)}
    .brand{font-weight:800;letter-spacing:.2px}
    .toolbar{display:flex;gap:8px}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:var(--panel-2);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;min-height:44px}
    .btn:active{transform:translateY(1px)}
    .hero{padding:12px 16px}
    .hero h1{font-size:clamp(22px,5vw,34px);margin:0 0 4px}
    .muted{color:var(--muted)}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow);margin-bottom:12px}
    .card h2{margin:6px 0 8px;font-size:20px}
    .card h3{margin:10px 0 6px;font-size:17px}
    ul.clean{margin:8px 0 0;padding:0 0 0 18px}
    li+li{margin-top:6px}

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .sessions{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:900px){.sessions{grid-template-columns:1fr 1fr}}
    .session{border:1px dashed var(--border);border-radius:12px;padding:12px}

    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;background:color-mix(in srgb,var(--panel-2),transparent 30%);font-size:12px;color:var(--muted)}

    .weeks{display:grid;gap:8px}
    .week-row{display:grid;grid-template-columns:110px repeat(3,1fr);gap:8px;align-items:center}
    .week-row .label{font-weight:700}
    .cb{display:flex;align-items:center;gap:8px;padding:8px;border:1px solid var(--border);border-radius:10px;background:color-mix(in srgb,var(--panel-2),transparent 40%)}
    .cb input{transform:scale(1.2)}

    .timer-card{position:relative}
    .timer-display{font-variant-numeric:tabular-nums; font-size: clamp(28px, 12vw, 56px); font-weight: 800; letter-spacing: .03em; text-align:center; margin: 6px 0 0}
    .timer-step{ text-align:center; margin-top:4px; color:var(--muted)}
    .timer-controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .selects{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .selects select, .selects input{width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--panel-2); color:var(--text)}

    .sticky-bottom{position:sticky;bottom:0;z-index:40;background:linear-gradient(0deg,var(--panel),transparent 70%);padding-bottom:env(safe-area-inset-bottom)}
    .bottom-bar{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .bottom-bar .btn{justify-content:center}

    footer{margin:20px 0 80px;color:var(--muted);text-align:center}

    @media (max-width:480px){
      .toolbar a{display:none}
      .week-row{grid-template-columns:90px repeat(3,1fr)}
    }
  </style>
</head>
<body class="light" data-theme="light">
  <header>
    <nav class="nav container" aria-label="Navigation principale">
      <div class="brand">Traction 1â€‘Bras Â· 12Â sem</div>
      <div class="toolbar">
        <button class="btn" id="themeBtn" title="Mode sombre/clair">ğŸŒ— ThÃ¨me</button>
        <button class="btn" id="printBtn" title="Imprimer/PDF">ğŸ–¨ï¸</button>
      </div>
    </nav>
  </header>

  <section class="hero container">
    <h1>Programme Traaction Ã  un bras â€” 12Â semaines</h1>
    <p class="muted">OptimisÃ© smartphone. Timers intÃ©grÃ©s + export <strong>.ics</strong> pour alarmes systÃ¨me qui sonnent mÃªme Ã©cran Ã©teint.</p>
  </section>

  <main class="container grid">
    <section class="card">
      <h2>Timers d'entraÃ®nement (mobile)</h2>
      <div class="timer-card">
        <div class="selects">
          <select id="presetSelect" aria-label="Choisir une sÃ©ance">
            <option value="b1a">BlocÂ 1 Â· SÃ©anceÂ A</option>
            <option value="b1b">BlocÂ 1 Â· SÃ©anceÂ B</option>
            <option value="b1c">BlocÂ 1 Â· SÃ©anceÂ C</option>
            <option value="b2a">BlocÂ 2 Â· SÃ©anceÂ A</option>
            <option value="b2b">BlocÂ 2 Â· SÃ©anceÂ B</option>
            <option value="b2c">BlocÂ 2 Â· SÃ©anceÂ C</option>
            <option value="b3a">BlocÂ 3 Â· SÃ©anceÂ A</option>
            <option value="b3b">BlocÂ 3 Â· SÃ©anceÂ B</option>
            <option value="b3c">BlocÂ 3 Â· SÃ©anceÂ C</option>
          </select>
          <select id="modeSelect" aria-label="Mode du minuteur">
            <option value="web">Mode chrono (nÃ©cessite Ã©cran allumÃ©)</option>
            <option value="ics">Mode alarme (calendrier .ics)</option>
          </select>
        </div>
        <div class="selects">
          <input type="datetime-local" id="startAt" aria-label="Heure de dÃ©but pour .ics" />
          <select id="tzSelect" aria-label="Fuseau horaire">
            <option value="local" selected>Fuseau local</option>
            <option value="UTC">UTC</option>
          </select>
        </div>
        <div class="timer-display" id="timerDisplay">00:00</div>
        <div class="timer-step" id="timerStep">SÃ©lectionne un preset puis <strong>DÃ©marrer</strong>.</div>
        <div class="timer-controls sticky-bottom">
          <div class="bottom-bar">
            <button class="btn" id="startBtn">â–¶ï¸ DÃ©marrer</button>
            <button class="btn" id="pauseBtn" disabled>â¸ï¸ Pause</button>
            <button class="btn" id="resetBtn" disabled>âŸ² RÃ©initialiser</button>
            <button class="btn" id="wakelockBtn" title="Garder l'Ã©cran allumÃ©">ğŸ”’ Ã‰cran allumÃ©</button>
          </div>
          <div style="margin-top:8px; text-align:center">
            <button class="btn" id="exportIcsBtn" title="Exporter calendrier (.ics)">ğŸ“… Export .ics (alarmess Ã©cran Ã©teint)</button>
          </div>
        </div>
      </div>
      <p class="muted" style="margin-top:8px">
        âš ï¸ Les navigateurs mobiles suspendent les sons/minuteurs en arriÃ¨reâ€‘plan. Pour des alarmes fiables <em>Ã©cran Ã©teint</em>, utilise le bouton <strong>Export .ics</strong> et ajoute l'Ã©vÃ©nement Ã  ton agenda (l'alarme sera gÃ©rÃ©e par le systÃ¨me).
      </p>
    </section>

    <section class="card">
      <h2>Principes & Ã‰chauffement</h2>
      <div class="sessions">
        <div>
          <h3>Principes clÃ©s</h3>
          <ul id="principles" class="clean"></ul>
          <span class="pill">RIRÂ 1â€“2</span> <span class="pill">ExcentriquesÂ 6â€“10Â s</span> <span class="pill">Repos lourdsÂ 2â€“4Â min</span>
        </div>
        <div>
          <h3>Ã‰chauffement (10â€“12Â min)</h3>
          <ul id="warmup" class="clean"></ul>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>BlocÂ 1 â€“ Base & tissus (Sem.Â 1â€“4)</h2>
      <p class="muted">Ordre vÃ©rifiÃ©Â : exercice le plus dur juste aprÃ¨s l'Ã©chauffement. <span class="pill">Sem.Â 4Â : deload</span></p>
      <div class="sessions" id="block1"></div>
    </section>

    <section class="card">
      <h2>BlocÂ 2 â€“ Intensification (Sem.Â 5â€“8)</h2>
      <p class="muted"><span class="pill">Sem.Â 8Â : deload</span></p>
      <div class="sessions" id="block2"></div>
    </section>

    <section class="card">
      <h2>BlocÂ 3 â€“ RÃ©alisation (Sem.Â 9â€“12)</h2>
      <p class="muted"><span class="pill">Sem.Â 12Â : test</span></p>
      <div class="sessions" id="block3"></div>
      <details style="margin-top:10px">
        <summary><strong>SemaineÂ 12 â€“ Test & repÃ¨res</strong></summary>
        <ul class="clean">
          <li>Singles 1â€‘bras avec assistance minimale â†’ tente sans aide si propre.</li>
          <li>RepÃ¨resÂ : excentriques 8â€“10Â s Ã— 3â€“5; isos top & mid 20Â s; uneven 4Ã—6; lestÃ©es 3Ã—3 Ã  +15â€“25Â % PDC.</li>
        </ul>
      </details>
    </section>

    <section class="card">
      <h2>Suivi hebdo</h2>
      <div id="weeks" class="weeks"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
        <button class="btn" id="weeksReset">RÃ©initialiser</button>
        <button class="btn" id="weeksExport">Exporter</button>
        <input type="file" id="weeksImportFile" accept="application/json" style="display:none" />
        <button class="btn" id="weeksImport">Importer</button>
      </div>
    </section>
  </main>

  <footer class="container">
    <p>Â© Programme traction 1â€‘bras. Site statique. Aucune donnÃ©e envoyÃ©e. Checklists & prÃ©fÃ©rences stockÃ©es localement.</p>
  </footer>

  <script>
    // ======================= DonnÃ©es =======================
    const PRINCIPLES = [
      "FrÃ©quenceÂ : 3 sÃ©ances/sem (ex. Lunâ€“Jeuâ€“Sam).",
      "IntensitÃ©Â : garde 1â€“2 reps en rÃ©serve (Ã©vite lâ€™Ã©chec).",
      "TempoÂ : contrÃ´le totalÂ ; excentriques lents (6â€“10Â s).",
      "Assistance rÃ©glableÂ : anneau/serviette, pied sur box, ou bande â€“ rÃ©duis lâ€™assistance au fil des semaines.",
      "Ordre vÃ©rifiÃ©Â : Ã©chauffement â†’ exercice le plus dur â†’ secondaires â†’ accessoires â†’ prÃ©hab/core (rien de max en fin de sÃ©ance)."
    ];

    const WARMUP = [
      "Pendaisons activesÂ 2Ã—20Â s (dÃ©pressions scapulaires).",
      "Rotateurs externes Ã©lastiqueÂ 2Ã—12/bras.",
      "Scap pullâ€‘upsÂ 2Ã—8 (Ã  2Â mains).",
      "Poignets/avantâ€‘brasÂ : pronationâ€“supinationÂ 2Ã—12, extensions de poignetÂ 2Ã—15.",
      "CoreÂ : hollow holdÂ 2Ã—20â€“30Â s."
    ];

    const BLOCKS = [
      {id:1, title:"Bloc 1 â€“ Base & tissus (Sem. 1â€“4)", weeks:[1,2,3,4], flags:{4:'DELOAD'}, sessions:{
        A:{ title:"SÃ©ance A (ordre vÃ©rifiÃ©)", rest:"2â€“3Â min excentriques/isos; 90â€“120Â s le reste.", items:[
            "Excentriques 1â€‘bras (assistÃ©es)Â : 3Ã—3â€“5/bras @ 4â€“6Â s.",
            "IsomÃ©triques 1â€‘bras (haut/milieu/bas)Â : 2â€“3Â sÃ©ries Ã— 10â€“15Â s.",
            "Archer pullâ€‘upsÂ : 3Ã—5â€“8/side.",
            "PrÃ©hab coude (curl marteau/inversÃ©)Â : 3Ã—12â€“15.",
            "Core antiâ€‘rotation (sideâ€‘plank)Â : 3Ã—20â€“30Â s/side."
        ]},
        B:{ title:"SÃ©ance B (ordre vÃ©rifiÃ©)", rest:"2â€“4Â min lestÃ©es; 2Â min uneven; 90Â s accessoires.", items:[
            "Tractions lestÃ©es (2Â mains)Â : 4Ã—4â€“6 @ RPEÂ 7â€“8.",
            "Uneven pullâ€‘upsÂ : 4Ã—4â€“6/side.",
            "Scap depressions 1â€‘bras (pied sur box)Â : 3Ã—8â€“10/bras.",
            "Farmer carry lourd (1Â bras)Â : 3Ã—20â€“30Â m/side."
        ]},
        C:{ title:"SÃ©ance C (ordre vÃ©rifiÃ©)", rest:"2â€“3Â min typewriter/isos; 90â€“120Â s accessoires.", items:[
            "TypewriterÂ : 3Ã—4â€“6 allersâ€‘retours.",
            "IsomÃ©triques 1â€‘bras (milieu)Â : 3Ã—15â€“20Â s/bras.",
            "Ã‰lastique 1â€‘bras (lat pull)Â : 4Ã—6â€“8/bras.",
            "Core (dead bug)Â : 3Ã—8â€“10/side."
        ]}
      }},
      {id:2, title:"Bloc 2 â€“ Intensification (Sem. 5â€“8)", weeks:[5,6,7,8], flags:{8:'DELOAD'}, sessions:{
        A:{ title:"SÃ©ance A (ordre vÃ©rifiÃ©)", rest:"2â€“3Â min excentriques/isos; 2Â min uneven; 90Â s curl.", items:[
            "Excentriques 1â€‘brasÂ : 4Ã—3/bras @ 6â€“8Â s (ajoute 1â€“2Â kg si facile).",
            "IsomÃ©triques 1â€‘bras (haut & milieu)Â : 2Ã—15â€“20Â s.",
            "Uneven pullâ€‘upsÂ : 4Ã—5/side.",
            "Curl brachial + supinationÂ : 3Ã—10â€“12."
        ]},
        B:{ title:"SÃ©ance B (ordre vÃ©rifiÃ©)", rest:"3â€“4Â min lestÃ©es; 2Â min archer; 90Â s accessoires.", items:[
            "Tractions lestÃ©esÂ : 5Ã—3 @ RPEÂ 8â€“9.",
            "Archer strictsÂ : 3Ã—6/side.",
            "Scap pullâ€‘ups (2Â mains)Â : 3Ã—10 (pause 1Â s).",
            "Pallof pressÂ : 3Ã—10â€“12/side."
        ]},
        C:{ title:"SÃ©ance C (ordre vÃ©rifiÃ©)", rest:"2â€“3Â min entre singles; 2â€“3Â min contrast; 90Â s hangs.", items:[
            "Concentriques 1â€‘bras assistÃ©esÂ : 6â€“8Ã—1â€“3/bras @ RPEÂ 7â€“8.",
            "ContrastÂ : 1 excentrique 8â€“10Â s â†’ 1â€“2 reps assistÃ©es (Ã—3).",
            "Oneâ€‘arm hang assistÃ©Â : 3Ã—8â€“12Â s/bras."
        ]}
      }},
      {id:3, title:"Bloc 3 â€“ RÃ©alisation (Sem. 9â€“12)", weeks:[9,10,11,12], flags:{12:'TEST'}, sessions:{
        A:{ title:"SÃ©ance A (ordre vÃ©rifiÃ©)", rest:"2â€“3Â min singles; 2Â min iso; 90â€“120Â s entretien.", items:[
            "Tractions 1â€‘bras assistÃ©es Â«Â faiblesÂ Â»Â : 5â€“7Ã—1â€“2/bras @ RPEÂ 8â€“9.",
            "IsomÃ©triques 1â€‘bras (milieu)Â : 3Ã—10â€“15Â s/bras.",
            "Typewriter/archerÂ : 3Ã—4/side."
        ]},
        B:{ title:"SÃ©ance B (ordre vÃ©rifiÃ©)", rest:"3â€“4Â min lestÃ©es; 2â€“3Â min excentriques; 90Â s accessoires.", items:[
            "Tractions lestÃ©es (entretien)Â : 3Ã—2â€“3 (lourdes).",
            "Excentriques 1â€‘brasÂ : 3Ã—2/bras @ 10Â s.",
            "Scap 1â€‘brasÂ : 3Ã—8/bras.",
            "Hollow rocksÂ : 3Ã—15â€“20."
        ]},
        C:{ title:"SÃ©ance C (ordre vÃ©rifiÃ©)", rest:"2â€“3Â min entre singles; 90â€“120Â s le reste.", items:[
            "Testâ€‘likeÂ : 6â€“8 singles/bras (assistance minimale).",
            "Oneâ€‘arm hang assistÃ©Â : 3Ã—10â€“15Â s/bras.",
            "Pendaison passiveÂ : 2Ã—40Â s."
        ]}
      }}
    ];

    // Presets pour timer (sÃ©quences approximatives Ã©ditables si besoin)
    // Chaque item: {label, sec}
    const PRESETS = {
      b1a:[
        {label:"Ã‰chauffement", sec: 10*60},
        {label:"Excentriques 1â€‘bras â€“ SÃ©rie 1", sec: 60}, {label:"Repos", sec: 180},
        {label:"Excentriques 1â€‘bras â€“ SÃ©rie 2", sec: 60}, {label:"Repos", sec: 180},
        {label:"Excentriques 1â€‘bras â€“ SÃ©rie 3", sec: 60}, {label:"Repos", sec: 180},
        {label:"IsomÃ©triques top/mid/bas", sec: 3*60}, {label:"Repos", sec: 120},
        {label:"Archer pullâ€‘ups", sec: 2*60}
      ],
      b1b:[
        {label:"Ã‰chauffement", sec: 8*60},
        {label:"LestÃ©es 2Â mains â€“ 1", sec: 60}, {label:"Repos", sec: 210},
        {label:"LestÃ©es 2Â mains â€“ 2", sec: 60}, {label:"Repos", sec: 210},
        {label:"LestÃ©es 2Â mains â€“ 3", sec: 60}, {label:"Repos", sec: 210},
        {label:"Uneven â€“ sÃ©ries", sec: 2*60}
      ],
      b1c:[
        {label:"Ã‰chauffement", sec: 8*60},
        {label:"Typewriter", sec: 3*60}, {label:"Isos milieu", sec: 3*45}, {label:"Ã‰lastique 1â€‘bras", sec: 4*45}
      ],
      b2a:[
        {label:"Ã‰chauffement", sec: 8*60},
        {label:"Excentriques 1â€‘bras â€“ 1", sec: 60}, {label:"Repos", sec: 180},
        {label:"Excentriques 1â€‘bras â€“ 2", sec: 60}, {label:"Repos", sec: 180},
        {label:"Excentriques 1â€‘bras â€“ 3", sec: 60}, {label:"Repos", sec: 180},
        {label:"Isos haut/mid", sec: 2*60}
      ],
      b2b:[
        {label:"Ã‰chauffement", sec: 8*60},
        {label:"LestÃ©es â€“ 1", sec: 60}, {label:"Repos", sec: 210},
        {label:"LestÃ©es â€“ 2", sec: 60}, {label:"Repos", sec: 210},
        {label:"LestÃ©es â€“ 3", sec: 60}, {label:"Repos", sec: 210},
        {label:"Archer stricts", sec: 2*60}
      ],
      b2c:[
        {label:"Ã‰chauffement", sec: 8*60},
        {label:"Singles assistÃ©s â€“ boucle", sec: 6*90}, {label:"Contrast (eccâ†’assiste)", sec: 3*120}
      ],
      b3a:[
        {label:"Ã‰chauffement", sec: 8*60},
        {label:"Singles assistÃ©s", sec: 7*90}, {label:"Isos milieu", sec: 3*60}, {label:"Typewriter/archer", sec: 3*60}
      ],
      b3b:[
        {label:"Ã‰chauffement", sec: 8*60},
        {label:"LestÃ©es 2â€“3 reps", sec: 3*90}, {label:"Excentriques 10Â s", sec: 3*60}, {label:"Scap 1â€‘bras", sec: 3*45}
      ],
      b3c:[
        {label:"Ã‰chauffement", sec: 8*60},
        {label:"Testâ€‘like singles", sec: 8*90}, {label:"Oneâ€‘arm hang", sec: 3*45}, {label:"Pendaison passive", sec: 2*40}
      ]
    };

    // ======================= Rendu fixe =======================
    const elP = document.getElementById('principles'); PRINCIPLES.forEach(t=>{const li=document.createElement('li'); li.textContent=t; elP.appendChild(li)});
    const elW = document.getElementById('warmup'); WARMUP.forEach(t=>{const li=document.createElement('li'); li.textContent=t; elW.appendChild(li)});

    const renderSession = (s)=>{const d=document.createElement('div'); d.className='session'; const h=document.createElement('h3'); h.textContent=s.title; d.appendChild(h); const ul=document.createElement('ul'); ul.className='clean'; s.items.forEach(it=>{const li=document.createElement('li'); li.textContent=it; ul.appendChild(li)}); d.appendChild(ul); const p=document.createElement('p'); p.className='muted'; p.textContent='ReposÂ : '+s.rest; d.appendChild(p); return d};
    const mountBlock = (block, id)=>{const root=document.getElementById(id); ['A','B','C'].forEach(k=>root.appendChild(renderSession(block.sessions[k]))) };
    mountBlock(BLOCKS[0],'block1'); mountBlock(BLOCKS[1],'block2'); mountBlock(BLOCKS[2],'block3');

    // ======================= Suivi hebdo =======================
    const weeksHost = document.getElementById('weeks');
    const WEEKS_ALL = [...BLOCKS[0].weeks,...BLOCKS[1].weeks,...BLOCKS[2].weeks];
    const keyFor = (w,s)=>`onearm-v2-week-${w}-${s}`;
    WEEKS_ALL.forEach(w=>{
      const row=document.createElement('div'); row.className='week-row';
      const lab=document.createElement('div'); lab.className='label'; lab.textContent=`Semaine ${w}`; const f=BLOCKS.find(b=>b.weeks.includes(w)); if(f&&f.flags&&f.flags[w]){const span=document.createElement('span'); span.className='pill'; span.textContent=f.flags[w]; lab.appendChild(span)}; row.appendChild(lab);
      ['A','B','C'].forEach(s=>{const wr=document.createElement('label'); wr.className='cb'; const cb=document.createElement('input'); cb.type='checkbox'; const k=keyFor(w,s); cb.checked=localStorage.getItem(k)==='1'; cb.addEventListener('change',()=>localStorage.setItem(k,cb.checked?'1':'0')); const sp=document.createElement('span'); sp.textContent=`SÃ©ance ${s}`; wr.appendChild(cb); wr.appendChild(sp); row.appendChild(wr)});
      weeksHost.appendChild(row);
    });
    document.getElementById('weeksReset').addEventListener('click',()=>{ if(!confirm('RÃ©initialiser toutes les cases ?')) return; WEEKS_ALL.forEach(w=>['A','B','C'].forEach(s=>localStorage.removeItem(keyFor(w,s)))); document.querySelectorAll('#weeks input[type="checkbox"]').forEach(cb=>cb.checked=false) });
    document.getElementById('weeksExport').addEventListener('click',()=>{const data={}; WEEKS_ALL.forEach(w=>['A','B','C'].forEach(s=>data[keyFor(w,s)]=localStorage.getItem(keyFor(w,s))||'0')); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='progress_onearm.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),3000)});
    document.getElementById('weeksImport').addEventListener('click',()=>document.getElementById('weeksImportFile').click());
    document.getElementById('weeksImportFile').addEventListener('change',async e=>{const f=e.target.files?.[0]; if(!f) return; const txt=await f.text(); try{const data=JSON.parse(txt); Object.entries(data).forEach(([k,v])=>localStorage.setItem(k,v)); document.querySelectorAll('#weeks .week-row').forEach((row,idx)=>{const week=WEEKS_ALL[idx]; const boxes=row.querySelectorAll('input[type="checkbox"]'); ['A','B','C'].forEach((s,i)=>{boxes[i].checked=(localStorage.getItem(keyFor(week,s))==='1')})}); alert('Suivi importÃ© âœ”')}catch(err){alert('Fichier invalide')}});

    // ======================= Timer (web) =======================
    let queue=[]; let currentIndex=-1; let remaining=0; let intervalId=null; let audioCtx=null; let wakelock=null;
    const disp=document.getElementById('timerDisplay'); const stepLbl=document.getElementById('timerStep');
    const startBtn=document.getElementById('startBtn'); const pauseBtn=document.getElementById('pauseBtn'); const resetBtn=document.getElementById('resetBtn');

    function fmt(sec){const m=Math.floor(sec/60).toString().padStart(2,'0'); const s=Math.floor(sec%60).toString().padStart(2,'0'); return `${m}:${s}`}
    function beep(ms=500){try{ if(!audioCtx){audioCtx=new (window.AudioContext||window.webkitAudioContext)();} const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type='sine'; o.frequency.value=880; g.gain.value=0.05; o.start(); setTimeout(()=>{o.stop();}, ms); if(navigator.vibrate) navigator.vibrate([60,60,60]); }catch(e){} }

    async function toggleWake(){ const btn=document.getElementById('wakelockBtn'); if(!('wakeLock' in navigator)){ alert("Wake Lock non pris en charge sur ce navigateur"); return; } try{ if(!wakelock){ wakelock=await navigator.wakeLock.request('screen'); btn.textContent='ğŸ”“ Ã‰cran allumÃ© (ON)'; wakelock.addEventListener('release',()=>{btn.textContent='ğŸ”’ Ã‰cran allumÃ©'}) } else { wakelock.release(); wakelock=null; btn.textContent='ğŸ”’ Ã‰cran allumÃ©'; } }catch(e){ alert('Impossible d\'activer le Wake Lock'); } }

    function loadPreset(){ const key=document.getElementById('presetSelect').value; queue = (PRESETS[key]||[]).map(x=>({...x})); currentIndex=-1; remaining=0; updateDisplay(); }
    function updateDisplay(){ disp.textContent = fmt(remaining||0); stepLbl.innerHTML = queue[currentIndex]?.label ? `Ã‰tapeÂ : <strong>${queue[currentIndex].label}</strong>` : 'PrÃªt'; }

    function nextStep(){ currentIndex++; if(currentIndex>=queue.length){ clearInterval(intervalId); intervalId=null; startBtn.disabled=false; pauseBtn.disabled=true; resetBtn.disabled=false; stepLbl.innerHTML='TerminÃ© âœ”'; beep(800); return; } remaining=queue[currentIndex].sec; updateDisplay(); beep(200); }

    function tick(){ if(remaining>0){ remaining-=1; disp.textContent=fmt(remaining); if(remaining<=0){ nextStep(); } } }

    startBtn.addEventListener('click', async ()=>{ if(document.getElementById('modeSelect').value==='ics'){ buildAndDownloadICS(); return; } if(!queue.length) loadPreset(); if(!audioCtx){ try{audioCtx=new (window.AudioContext||window.webkitAudioContext)(); await audioCtx.resume(); }catch(e){} } if(intervalId){ return; } if(currentIndex===-1) nextStep(); intervalId=setInterval(tick,1000); startBtn.disabled=true; pauseBtn.disabled=false; resetBtn.disabled=false; });
    pauseBtn.addEventListener('click', ()=>{ if(intervalId){ clearInterval(intervalId); intervalId=null; startBtn.disabled=false; pauseBtn.disabled=true; }});
    resetBtn.addEventListener('click', ()=>{ if(intervalId){ clearInterval(intervalId); intervalId=null; } currentIndex=-1; remaining=0; updateDisplay(); startBtn.disabled=false; pauseBtn.disabled=true; resetBtn.disabled=true; });
    document.getElementById('wakelockBtn').addEventListener('click', toggleWake);
    document.getElementById('presetSelect').addEventListener('change', ()=>{ resetBtn.click(); loadPreset(); });

    // ======================= Export ICS (alarmess Ã©cran Ã©teint) =======================
    function toICSDate(d){ const pad=n=>String(n).padStart(2,'0'); const YYYY=d.getUTCFullYear(); const MM=pad(d.getUTCMonth()+1); const DD=pad(d.getUTCDate()); const hh=pad(d.getUTCHours()); const mm=pad(d.getUTCMinutes()); const ss=pad(d.getUTCSeconds()); return `${YYYY}${MM}${DD}T${hh}${mm}${ss}Z`; }

    function buildICSFromQueue(start){ let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Traction1Bras//OnePager//FR\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n'; let cursor=new Date(start);
      for(let i=0;i<queue.length;i++){
        const step=queue[i]; const dtStart = new Date(cursor); const dtEnd = new Date(cursor.getTime()+step.sec*1000);
        const uid = `onearm-${Date.now()}-${i}@traction`; ics+= 'BEGIN:VEVENT\n'; ics+= `UID:${uid}\n`; ics+= `DTSTAMP:${toICSDate(new Date())}\n`; ics+= `DTSTART:${toICSDate(dtStart)}\n`; ics+= `DTEND:${toICSDate(dtEnd)}\n`; ics+= `SUMMARY:${step.label.replace(/[,\n]/g,' ')}\n`; ics+= 'BEGIN:VALARM\nACTION:DISPLAY\nDESCRIPTION:Etape\nTRIGGER:PT0S\nEND:VALARM\n'; ics+= 'END:VEVENT\n'; cursor=dtEnd; }
      ics+='END:VCALENDAR\n'; return ics; }

    function buildAndDownloadICS(){ if(!queue.length) loadPreset(); const inp=document.getElementById('startAt'); let start=new Date(); if(inp && inp.value){ start = new Date(inp.value); }
      // Convert local to UTC automatically via toICSDate; if tzSelect==='UTC', we treat input as UTC already
      const ics = buildICSFromQueue(start);
      const blob = new Blob([ics], {type:'text/calendar'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='seance_traction_one_arm.ics'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),3000);
      alert('Fichier .ics gÃ©nÃ©rÃ©. Ajoute-le Ã  ton calendrier pour des alarmes fiables, mÃªme Ã©cran Ã©teint.');
    }
    document.getElementById('exportIcsBtn').addEventListener('click', buildAndDownloadICS);

    // ======================= ThÃ¨me & impression =======================
    const themeBtn=document.getElementById('themeBtn'); const root=document.body; const saveTheme=t=>localStorage.setItem('theme-onearm',''+t); const loadTheme=()=>localStorage.getItem('theme-onearm')||'light'; const applyTheme=t=>{ root.className = (t==='dark')? '' : 'light'; root.dataset.theme=t; themeBtn.textContent = (t==='dark')? 'ğŸŒ ThÃ¨me' : 'ğŸŒ— ThÃ¨me';}; applyTheme(loadTheme()); themeBtn.addEventListener('click',()=>{const next=(root.dataset.theme==='dark')?'light':'dark'; applyTheme(next); saveTheme(next);});
    document.getElementById('printBtn').addEventListener('click',()=>window.print());

    // Init
    loadPreset(); updateDisplay();
  </script>
</body>
</html>
